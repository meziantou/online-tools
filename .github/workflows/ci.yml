name: 'Publish application'
# This workflow builds and deploys the application to Azure Static Web Apps.
# For pull requests, it also manages preview environments by automatically deleting
# the oldest preview environment if there are already 3 or more.
#
# Required secrets:
# - AZURE_STATIC_WEB_APPS_API_TOKEN_PURPLE_GROUND_0F9AEF10F: Azure Static Web Apps deployment token
# - AZURE_CREDENTIALS: Azure service principal credentials (optional, for preview environment management)
# - AZURE_STATIC_WEB_APP_NAME: Name of the Azure Static Web App (optional, for preview environment management)
# - AZURE_RESOURCE_GROUP: Azure resource group name (optional, for preview environment management)
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

jobs:
  build:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    env:
      DOTNET_NOLOGO: true

    steps:
      - uses: actions/checkout@v6

      - name: Setup .NET Core
        uses: actions/setup-dotnet@v5

      - name: Test
        run: dotnet test

      - name: Publish
        run: dotnet publish Meziantou.OnlineTools --configuration Release

      - name: Cache buster
        env:
          DOTNET_ROLL_FORWARD: Major
        run: |
          dotnet tool install --global Meziantou.Framework.Html.Tool
          meziantou.html append-version --file-pattern "Meziantou.OnlineTools/bin/Release/net10.0/publish/wwwroot/**/*.html"

      # Preview environment management: Login to Azure to manage preview environments
      # This step will fail gracefully if AZURE_CREDENTIALS is not configured
      - name: Check and Cleanup Preview Environments
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Delete the oldest preview environment if there are already 3 or more
      # This prevents hitting the Azure Static Web Apps preview environment limit
      - name: Delete Oldest Preview Environment if Limit Reached
        if: github.event_name == 'pull_request'
        continue-on-error: true
        run: |
          # List all environments
          environments=$(az staticwebapp environment list \
            --name ${{ secrets.AZURE_STATIC_WEB_APP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --output json)

          # Filter out the default/production environment and count preview environments
          preview_count=$(echo "$environments" | jq '[.[] | select(.name != "default")] | length')

          echo "Current preview environment count: $preview_count"

          # If we have 3 or more preview environments, delete the oldest one
          if [ "$preview_count" -ge 3 ]; then
            echo "Preview environment limit reached. Deleting oldest environment..."

            # Get the oldest preview environment (sort by creation date)
            oldest_env=$(echo "$environments" | jq -r '[.[] | select(.name != "default")] | sort_by(.properties.createdTimeUtc // .properties.buildProperties.buildId // .name) | .[0].name')

            echo "Deleting environment: $oldest_env"
            az staticwebapp environment delete \
              --name ${{ secrets.AZURE_STATIC_WEB_APP_NAME }} \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --environment-name "$oldest_env" \
              --yes

            echo "Deleted oldest preview environment: $oldest_env"
          else
            echo "Preview environment count is within limit. No cleanup needed."
          fi

      - name: Build And Deploy
        id: builddeploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_PURPLE_GROUND_0F9AEF10F }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "Meziantou.OnlineTools/bin/Release/net10.0/publish/wwwroot"
          api_location: ""
          output_location: ""
          skip_app_build: true

  close_pull_request_job:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    name: Close Pull Request Job
    steps:
      - name: Close Pull Request
        id: closepullrequest
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_PURPLE_GROUND_0F9AEF10F }}
          action: "close"
