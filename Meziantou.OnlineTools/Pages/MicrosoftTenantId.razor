@page "/microsoft-tenant-id"
@inject HttpClient Http
@using System.Text.Json

<h1>Microsoft Tenant ID Finder</h1>

<form @onsubmit="FindTenantId">
    <div class="form-group">
        <label for="domain">Domain Name</label>
        <input id="domain" class="form-control" @bind="domain" placeholder="e.g. meziantou.net" />
    </div>

    <button type="submit" class="btn btn-primary">Find Tenant ID</button>
</form>

@if (isLoading)
{
    <p>Loading...</p>
}

@if (!string.IsNullOrEmpty(error))
{
    <div class="alert alert-danger">@error</div>
}

@if (tenantId != null)
{
    <div class="alert alert-success">
        <strong>Tenant ID:</strong> @tenantId
    </div>

    <div>
        <h5>Full Response</h5>
        <pre>@jsonResponse</pre>
    </div>
}

@code {
    private string? domain;
    private string? tenantId;
    private string? jsonResponse;
    private string? error;
    private bool isLoading;

    private async Task FindTenantId()
    {
        isLoading = true;
        error = null;
        tenantId = null;
        jsonResponse = null;

        try
        {
            if (string.IsNullOrWhiteSpace(domain))
            {
                error = "Please enter a domain name.";
                return;
            }

            var url = $"https://login.microsoftonline.com/{domain}/.well-known/openid-configuration";
            var rawJson = await Http.GetStringAsync(url);

            using var doc = JsonDocument.Parse(rawJson);
            jsonResponse = JsonSerializer.Serialize(doc.RootElement, new JsonSerializerOptions { WriteIndented = true });

            // Try to extract from token_endpoint
            if (doc.RootElement.TryGetProperty("token_endpoint", out var tokenEndpoint))
            {
                var tokenUrl = tokenEndpoint.GetString();
                if (!string.IsNullOrEmpty(tokenUrl))
                {
                    tenantId = ExtractGuidFromUrl(tokenUrl);
                }
            }

            // Fallback to issuer if not found
            if (tenantId == null && doc.RootElement.TryGetProperty("issuer", out var issuer))
            {
                var issuerUrl = issuer.GetString();
                if (!string.IsNullOrEmpty(issuerUrl))
                {
                    tenantId = ExtractGuidFromUrl(issuerUrl);
                }
            }

            if (tenantId == null)
            {
                error = "Could not extract Tenant ID from the response.";
            }
        }
        catch (Exception ex)
        {
            error = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private string? ExtractGuidFromUrl(string url)
    {
        var parts = url.Split('/');
        foreach (var part in parts)
        {
            if (Guid.TryParse(part, out var guid))
            {
                return guid.ToString();
            }
        }
        return null;
    }
}
